<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product List</title>
    <link rel="stylesheet" href="/stylesheets/product.css">
    <script src="../public/javascripts/cart.js"></script> <!-- Ensure correct path -->
</head>
<body>
    <header>
        <a href="/homepage.html"><h1>Welcome to our CPT_S 489 Project!</h1></a>
        <nav>
            <ul>
                <li><a href="/homepage.html">ğŸ˜ï¸ Home</a></li>
                <li><a href="/about.html">ğŸ“š About</a></li>
                <li><a href="/search">ğŸ” Search</a></li>
                <li><a href="/cart/">ğŸ›’ Cart</a></li>
            </ul>
        </nav>
    </header>
    
    <div class="product-container">
        <% products.forEach(product => { %> <!-- Use forEach for correct iteration -->
            <div class="product">
                <img src="<%= product.imageUrl %>" alt="<%= product.name %>"> <!-- Correct use of EJS -->
                <h2><%= product.name %></h2>
                <p><%= product.description %></p>
                <p><a href="<%= product.guideUrl %>">Documentation for <%= product.name %></a></p>
                <p>Price: $<%= product.price.toFixed(2) %></p> <!-- Ensure price is properly formatted -->

                <!-- Ensure correct data types when calling addToCart -->
                <button onclick="addToCart('<%= product.name %>', 1, parseFloat('<%= product.price %>'))">Add to Cart</button>
            </div>
        <% }); %> <!-- Ensure proper closing of the forEach block -->
    </div>

    <script>
function addToCart(productName, quantity, price) {
  // Initial log to confirm function execution
  console.log("addToCart called:", { productName, quantity, price });

  // Check for undefined or null values
  if (!productName) {
    console.error("Product name is undefined or null");
  }

  if (!price && price !== 0) {
    console.error("Price is undefined or null");
  }

  // Confirm the data before making the fetch request
  console.log("Data to be sent:", {
    productName,
    quantity,
    price, // Check if this is a valid number
  });

  fetch('/cart/add-to-cart', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      productName,
      quantity,
      price, // Ensure 'price' is a valid number
    }),
  })
  .then((response) => {
    console.log("Response status:", response.status); // Check the HTTP status code

    if (!response.ok) { // If response is not OK, log details
      console.error("Failed to add to cart. Status:", response.status);
      throw new Error('Failed to add to cart');
    }

    return response.json(); // Parse the response as JSON
  })
  .then((data) => {
    console.log("Response data:", data); // Check the received data

    if (data.success) {
      console.log("Product successfully added to cart:", data);
      updateCart(); // Refresh cart display
    } else {
      console.error("Failed to add product to cart. Message:", data.message);
    }
  })
  .catch((error) => { // Handle errors from fetch
    console.error('Error in addToCart:', error);
  });
}

    </script>
</body>
</html>
