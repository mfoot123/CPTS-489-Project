<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product List</title>
    <link rel="stylesheet" href="/stylesheets/product.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" 
    crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <a href="/homepage.html"><h1>Welcome to our CPT_S 489 Project!</h1></a>
        <nav>
            <ul>
                <li><a href="/homepage.html">üèòÔ∏è Home</a></li>
                <li><a href="/about.html">üìö About</a></li>
                <li><a href="/search">üîç Search</a></li>
                <li><a href="/cart">üõí Cart</a></li>
            </ul>
        </nav>
    </header>

    <div class="message-container"></div>

    <!-- <%- include("cartmsg")%> -->
    
    <div class="product-container">
        <% products.forEach(product => { %>
            <div class="product">
                <img src="<%= product.imageUrl %>" alt="<%= product.name %>">
                <h2><%= product.name %></h2>
                <p><%= product.description %></p>
                <p><a href="<%= product.guideUrl %>">Documentation for <%= product.name %></a></p>
                <p>Price: $<%= product.price.toFixed(2) %></p> 

                <button onclick="addToCart('<%= product.name %>', 1, parseFloat('<%= product.price %>'))">Add to Cart</button>
            </div>
        <% }); %>
    </div>
    <script>
    function addToCart(productName, quantity, price) {
    console.log("addToCart called:", { productName, quantity, price });

    if (!productName) {
        console.error("Product name is undefined or null");
        return;
    }

    if (!price && price !== 0) {
        console.error("Price is undefined or null");
        return;
    }

    console.log("Data to be sent:", {
        productName,
        quantity,
        price,
    });

    fetch('/cart/add-to-cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            productName,
            quantity,
            price,
        }),
    })
    .then((response) => {
        console.log("Response status:", response.status);

        if (!response.ok) {
            console.error("Failed to add to cart. Status:", response.status);
            throw new Error('Failed to add to cart');
        }

        return response.json();
    })
    .then((data) => {
        console.log("Response data:", data);
        displayMessage(data.success ? 'added' : 'error', data.message);
    })
    .catch((error) => { 
        console.error('Error in addToCart:', error);
        displayMessage('error', error.toString());
    });
}

function displayMessage(type, message) {
    const messageContainer = document.querySelector('.message-container');
    if (!messageContainer) return;

    messageContainer.innerHTML = '';
    let alertType = type === 'error' ? 'alert-danger' : 'alert-success';
    let operation = type === 'added' ? 'added to' : 'updated in';
    let content = `
        <div class="alert ${alertType} alert-dismissible fade show" role="alert">
            ${message || `Product ${operation} the cart successfully!`}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    messageContainer.innerHTML = content;
}


    function updateCart() {
        fetch('/cart/cart-data')
        .then((response) => {
            if (!response.ok) {
            throw new Error('Failed to retrieve cart data');
            }
            return response.json();
        })
        .then((cart) => {
            const productSection = document.querySelector('.product-section');
            productSection.innerHTML = '';
    
            let totalPrice = 0;
    
            cart.forEach((item) => {
            const productDiv = document.createElement('div');
            productDiv.classList.add('product-container');
            productDiv.innerHTML = `
                <div class="product">
                <h2>${item.product_name}</h2>
                <p>Quantity: ${item.quantity}</p>
                <p>Price: $${item.product_price}</p>
                <button onclick="removeFromCart('${item.product_name}')">Remove from Cart</button>
                </div>
            `;
            productSection.appendChild(productDiv);
    
            totalPrice += item.product_price * item.quantity;
            });
    
            const totalSection = document.querySelector('.total-section h2');
            totalSection.textContent = `Total Price: $${totalPrice.toFixed(2)}`;
        })
        .catch((error) => {
            console.error('Error updating cart display:', error);
        });
    }
    </script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" 
integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" 
crossorigin="anonymous"></script>
</html>
